<% title " - #{@service_record['Gamertag']}'s Game History" %>
<% active_halo4 'active' %>
<% search_query @service_record['Gamertag'] %>

<div class="container" style="margin-top: 80px; min-width: 1300px; max-width: 1300px;">
  <div class="row-fluid">

    <%= h4_sidebar_game_history 'active' %>
    <%= render 'h4_sidebar' %>

    <div class="well span9" style="padding: 20px 0 0 0;">
      <% h4_rank_data = Halo4Controller.GetSimpleRankData(@service_record, 'medium') %>
      <div class="row-fluid visible-desktop visible-tablet">
        <div class="span8" style="margin: 10px 0 0 20px">
          <div class="gamertag-flairs">
            <img style="margin-top: -8px;" src="<%= X343ApiController.asset_url_generator_basic(@service_record['RankImageUrl']['BaseUrl'], @service_record['RankImageUrl']['AssetUrl'], 'medium') %>" />
            <a href="/halo4/servicerecord/<%= @service_record['Gamertag'] %>/">
						    <span class="gamertag-bar">
							    <%= @service_record['Gamertag'] %>
							  </span>
            </a>
            -
				    <span class="service-tag-bar">
				      <%= @service_record['ServiceTag'] %>
				    </span>
          </div>

          <div class="gamertag-quick-meta">
            <%= h4_rank_data[:specialization_block]['Name'] %>
          </div>
          <div class="cleaner"></div>
          <br>
          <div class="gamertag-ranking">
            <div class="gamertag-progress-info-left">
              0
            </div>
            <div class="gamertag-progress-info-right">
              <%= number_with_delimiter(h4_rank_data[:update_upper_xp], :delimiter => ',') %>
            </div>
            <div class="cleaner"></div>
            <div class="progress progress-striped active">
              <div class="bar" style="text-align: right; padding-right: 5px; width: <%= h4_rank_data[:update_percentage] %>%;">
                <%= number_with_delimiter(h4_rank_data[:update_current_xp], :delimiter => ',') %>
              </div>
            </div>
          </div>
        </div>
        <div class="span3">
          <div class="span4 campaign-completion">
            <img src="<%= Halo4Controller.CampaignProgressFromId(@service_record['GameModes'][0]['SinglePlayerDASO'].to_i, @service_record['GameModes'][0]['SinglePlayerDifficulty'].to_i, 'medium') %>" /><br>
            <span class="completion-title">Single Player</span>
          </div>
          <div class="span4 campaign-completion">
            <img src="<%= Halo4Controller.CampaignProgressFromId(@service_record['GameModes'][0]['CoopDASO'].to_i, @service_record['GameModes'][0]['CoopDifficulty'].to_i, 'medium') %>" /><br>
            <span class="completion-title">Co-op</span>
          </div>
          <div class="span4 csr-completion">
            <img src="https://assets.halowaypoint.com/games/h4/csr/v1/small/<%= Halo4Controller.GetHighestSkillRank(@service_record['SkillRanks'])  %>.png" /><br>
            <span class="completion-title">Highest CSR</span>
          </div>
        </div>
      </div>
    </div>
    <div class="well span9">
      <h3>Game History:</h3>
      <div class="row-fluid">
        <ul class="nav nav-tabs">
	      <% @game_modes.each do |mode| %>
            <li class="<% if mode['Id'] == @selected_gamemode %>active<% end %>"><a href="#gamemode-<%= mode['Id'] %>" data-toggle="tab"><%= mode['Name'] %></a></li>
		    <% end %>
        </ul>

        <div class="tabbable">
          <div class="tab-content">
            <% @game_modes.each do |mode| %>
              <div class="tab-pane <% if mode['Id'] == @selected_gamemode %>active<% end %>" id="gamemode-<%= mode['Id'] %>">
	              <!-- load matches, :) -->
                <table class="table table-bordered table-striped table-hover">
                  <thead>
                  <tr>
                    <td>Game Title</td>
                    <td>Place/Difficulty</td>
                    <td>Date</td>
                    <td>Personal Score</td>
                    <td>Standing</td>
                    <td>Map</td>
                    <td>Playlist</td>
                  </tr>
                  </thead>
                  <tbody>
                  <%
                  start = @start_index
                  if @selected_gamemode != mode['Id']
										start = 0
								  end

                  mode_recent_matches = X343ApiController.GetPlayerMatches(@service_record['Gamertag'], start, 36, mode['Id'])['Games']

						      if mode_recent_matches.count == 0
									%>
                    <tr>
	                    <td>
		                    No more games found
	                    </td>
	                    <td>N/A</td>
                      <td>N/A</td>
                      <td>N/A</td>
                      <td>N/A</td>
                      <td>N/A</td>
                      <td>N/A</td>
                    </tr>
                  <%
										next
									end

	                index = 1
                  mode_recent_matches.each do |match|
                    if index == 35
											break
	                  end
                  %>
                    <tr>
                      <td><a href="/halo4/servicerecord/<%= @service_record['Gamertag'] %>/match/<%= match['Id'] %>"><%= match['VariantName'] %></a></td>
                      <td>tbd</td>
                      <td><%= DateTime.strptime(match['EndDateUtc'], '%Y-%m-%dT%H:%M:%SZ').strftime('%d.%m.%Y') %></td>
                      <td><%= match['PersonalScore'] %></td>
                      <td><%= match['Standing'] %></td>
                      <td><%= match['MapVariantName'] %></td>
                      <td><%= match['PlayListName'] %></td>
                    </tr>
                  <% index += 1
                     end %>
                  </tbody>
                </table>
                <ul class="pager">
                  <li class="previous <% if start == 0 %> disabled <% end %>"><a href="#">? Older</a></li>
                  <li class="next <% if mode_recent_matches.count == 36 %> disabled <% end %>"><a href="#todo">Newer ?</a></li>
                </ul>


              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>