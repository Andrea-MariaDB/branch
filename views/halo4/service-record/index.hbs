<article id="halo4-service-record" class="halo-4 service-record-header">
	{{> halo4/service-record-header }}

	<div class="experience-bar" data-spy="affix" data-offset-top="540">
		{{> experience-bar }}
	</div>

	<div class="page-content fluid-container row">
		<div class="col-md-12">
			{{> flash-messages }}
		</div>

		<div class="col-md-10">
			<section id="service-record-stats">
				<div class="section-header">
					Service Record
				</div>
				<div class="row">
					<div class="col-lg-5 row">
						<div class="player-rank col-md-12">
							<% progression_percent = rank_progression_percentage() %>
							<div class="current-rank pull-left">
								SR <%= @serviceRecord['rankName'] %>
								<span class="xp">
									<%= @serviceRecord['rankStartXp'] %> xp
								</span>
							</div>
							<div class="next-rank pull-right">
								<% if @serviceRecord['nextRankName'] != '' %>
									<span class="xp">
										<%= @serviceRecord['nextRankStartXp'] %> xp
									</span>
									SR <%= @serviceRecord['nextRankName'] %>
								<% end %>
							</div>
							<div class="clearfix"></div>
							<div class="progress-bar-container">
								<div class="progress-bar" role="progressbar" aria-valuenow="<%= progression_percent %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= progression_percent %>%;">
									<%= progression_percent %>%<%= rank_progression_comparison() %>
								</div>
							</div>
						</div>
						<div class="top-medals col-md-12 no-p">
							<hr />
							<span>Top Medals</span>
							<div class="medals">
								{{#each serviceRecord.topMedals }}
									<div class="top-medal" style="background-image: url('{{ h4ResolveAsset this.imageUrl 'large' }}');"
										 data-toggle="tooltip" data-placement="bottom" data-html="true"
										 title="{{ this.name }} - {{ numberWithDelim this.totalMedals }} times <hr /> {{ this.description }}">
									</div>
								{{/each}}
							</div>
						</div>
					</div>
					<div class="col-lg-3 hidden-sm hidden-xs hidden-md">
						<canvas id="played-games-spread" width="400" height="400"></canvas>
					</div>
					<div class="col-lg-4">
						<ul class="list-group general-player-details">
							<li class="list-group-item">
								<span class="badge">{{ friendlyDate serviceRecord.firstPlayedUtc }}</span>
								First Played
							</li>

							<li class="list-group-item">
								<span class="badge">{{ friendlyDate serviceRecord.lastPlayedUtc }}</span>
								Last Played
							</li>

							<li class="list-group-item">
								<span class="badge">{{ h4FriendlyDuration serviceRecord.totalGameplay false }}</span>
								Playtime
							</li>

							<li class="list-group-item">
								<span class="badge">{{ numberWithDelim serviceRecord.spartanPoints }}</span>
								Spartan Points
							</li>

							<li class="list-group-item">
								<span class="badge">{{ serviceRecord.totalCommendationProgress }}%</span>
								Commendation Progression
							</li>

							<li class="list-group-item">
								<span class="badge">{{ numberWithDelim serviceRecord.totalMedalsEarned }}</span>
								Medals Earned
							</li>

							<li class="list-group-item">
								<span class="badge">{{ numberWithDelim serviceRecord.totalGamesStarted }}</span>
								Games Started
							</li>

							<li class="list-group-item">
								<span class="badge">{{ numberWithDelim serviceRecord.totalChallengesCompleted }}</span>
								Challenges Completed
							</li>

							<li class="list-group-item">
								<span class="badge">{{ numberWithDelim serviceRecord.totalLoadoutItemsPurchased }}</span>
								Purchased Loadout Items
							</li>
						</ul>
					</div>
				</div>
			</section>

			<section id="war-games-stats">
				<div class="section-header">
					War Games Stats
				</div>
				<div class="row">
					<div class="mode-stats col-md-9">
						<div class="stat col-md-4">
							<div class="value">{{ modeStats.warGames.kdRatio }}</div>
							<div class="key">Kill/Death Ratio</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.averagePersonalScore }}</div>
							<div class="key">Average Personal Score</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalKills }}</div>
							<div class="key">Total Kills</div>
						</div>

						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalDeaths }}</div>
							<div class="key">Total Deaths</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalGamesStarted }}</div>
							<div class="key">Total Games Started</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalGamesWon }}</div>
							<div class="key">Total Games Won</div>
						</div>

						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalGamesCompleted }}</div>
							<div class="key">Total Games Completed</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ numberWithDelim modeStats.warGames.totalGameBaseVariantMedals }}</div>
							<div class="key">Mode Base Medals</div>
						</div>
						<div class="stat col-md-4">
							<div class="value">{{ modeStats.warGames.totalDuration }}</div>
							<div class="key">Playtime</div>
						</div>
					</div>
					<div class="favourite-variant col-md-3">
						<div class="title">Favourite Variant</div>
						<div class="variant-icon" style="background-image: url('{{ h4ResolveAsset modeStats.warGames.favoriteVariant.imageUrl 'large' }}');"></div>
						<hr />

						<div class="col-md-12 row no-mp">
							<div class="col-md-12">{{ modeStats.warGames.favoriteVariant.name }}</div>
							<div class="stat col-md-6">
								<div class="value">{{ numberWithDelim modeStats.warGames.totalKills }}</div>
								<div class="key">Total Kills</div>
							</div>
							<div class="stat col-md-6">
								<div class="value">{{ numberWithDelim modeStats.warGames.totalDeaths }}</div>
								<div class="key">Total Deaths</div>
							</div>
							<div class="stat col-md-6">
								<div class="value">{{ numberWithDelim modeStats.warGames.totalGamesStarted }}</div>
								<div class="key">Games Started</div>
							</div>
							<div class="stat col-md-6">
								<div class="value">{{ modeStats.warGames.totalDuration }}</div>
								<div class="key">Playtime</div>
							</div>
						</div>
					</div>
				</div>
			</section>

			<section id="campaign-stats">
				<% campaign_stats = @serviceRecord['gameModes'].detect { |m| m['id'] == 4 } %>
				<div class="section-header">
					Campaign Stats
				</div>
				<div class="row">
					<div class="mode-stats col-md-9">
						<div class="stat col-md-4">
							<div class="value"><%= calculate_kd_ratio(campaign_stats['totalKills'], campaign_stats['totalDeaths']) %></div>
							<div class="key">Kill/Death Ratio</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(campaign_stats['totalKills']) %></div>
							<div class="key">Total Kills</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(campaign_stats['totalDeaths']) %></div>
							<div class="key">Total Deaths</div>
						</div>

						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(campaign_stats['totalGamesStarted']) %></div>
							<div class="key">Total Games Started</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(campaign_stats['totalTerminalsVisited']) %></div>
							<div class="key">Terminals Visited</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= campaign_stats['totalDuration'] %></div>
							<div class="key">Playtime</div>
						</div>
					</div>
					<div class="mission-progression col-md-3">
						<div class="title">Mission Progression</div>
						<hr />

						<div class="progressions col-md-12 row no-mp">
							<div class="progression col-md-6">
								<% asset, opacity, status = completion_difficulty_info(campaign_stats['singlePlayerDifficulty']) %>
								<div class="value" data-toggle="tooltip" data-placement="top" title="<%= status %>">
									<div class="value-image" style="background-image: url('<%= asset %>'); opacity: <%= opacity %>;"></div>
								</div>
								<div class="key">Single Player</div>
							</div>
							<div class="progression col-md-6">
								<% asset, opacity, status = completion_difficulty_info(campaign_stats['coopDifficulty']) %>
								<div class="value" data-toggle="tooltip" data-placement="top" title="<%= status %>">
									<div class="value-image" style="background-image: url('<%= asset %>'); opacity: <%= opacity %>;"></div>
								</div>
								<div class="key">Coop</div>
							</div>
							<div class="progression col-md-6">
								<% asset, opacity, status = completion_difficulty_info(campaign_stats['singlePlayerDASO']) %>
								<div class="value" data-toggle="tooltip" data-placement="top" title="<%= status %>">
									<div class="value-image" style="background-image: url('<%= asset %>'); opacity: <%= opacity %>;"></div>
								</div>
								<div class="key">Single Player (LASO)</div>
							</div>
							<div class="progression col-md-6">
								<% asset, opacity, status = completion_difficulty_info(campaign_stats['coopDASO']) %>
								<div class="value" data-toggle="tooltip" data-placement="top" title="<%= status %>">
									<div class="value-image" style="background-image: url('<%= asset %>'); opacity: <%= opacity %>;"></div>
								</div>
								<div class="key">Coop (LASO)</div>
							</div>
						</div>
					</div>
				</div>
			</section>

			<section id="spartan-ops-stats">
				<% spartan_ops_stats = @serviceRecord['gameModes'].detect { |m| m['id'] == 5 } %>
				<div class="section-header">
					Spartan Ops Stats
				</div>
				<div class="row">
					<div class="mode-stats col-md-9">
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(calculate_kd_ratio(spartan_ops_stats['totalKills'], spartan_ops_stats['totalDeaths'])) %></div>
							<div class="key">Kill/Death Ratio</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(spartan_ops_stats['totalKills']) %></div>
							<div class="key">Total Kills</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(spartan_ops_stats['totalDeaths']) %></div>
							<div class="key">Total Deaths</div>
						</div>

						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(spartan_ops_stats['totalMedals']) %></div>
							<div class="key">Total Medals</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(spartan_ops_stats['totalGamesStarted']) %></div>
							<div class="key">Total Games Started</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= spartan_ops_stats['totalDuration'] %></div>
							<div class="key">Playtime</div>
						</div>
					</div>
					<div class="mission-progression col-md-3 no-p">
						<div class="title">Mission Progression</div>
						<hr />
						<div class="progressions col-md-12 row no-mp">
							<div class="progression col-md-12">
								<% sp_completion = generate_percentage(spartan_ops_stats['totalSinglePlayerMissionsCompleted'], spartan_ops_stats['totalMissionsPossible']) %>
								<span>Single Player Mission Progression</span>
								<div class="progress-bar-container">
									<div class="progress-bar" role="progressbar" aria-valuenow="<%= sp_completion %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= sp_completion %>%;">
										<%= sp_completion %>% (<%= spartan_ops_stats['totalSinglePlayerMissionsCompleted'] %>/<%= spartan_ops_stats['totalMissionsPossible'] %>)
									</div>
								</div>
							</div>
							<div class="progression col-md-12">
								<% coop_completion = generate_percentage(spartan_ops_stats['totalCoopMissionsCompleted'], spartan_ops_stats['totalMissionsPossible']) %>
								<span>Coop Mission Progression</span>
								<div class="progress-bar-container">
									<div class="progress-bar" role="progressbar" aria-valuenow="<%= coop_completion %>" aria-valuemin="0" aria-valuemax="100" style="width: <%= coop_completion %>%;">
										<%= coop_completion %>% (<%= spartan_ops_stats['totalCoopMissionsCompleted'] %>/<%= spartan_ops_stats['totalMissionsPossible'] %>)
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</section>

			<section id="custom-games-stats">
				<% custom_games_stats = @serviceRecord['gameModes'].detect { |m| m['id'] == 6 } %>
				<div class="section-header">
					Customs Games Stats
				</div>
				<div class="row">
					<div class="mode-stats col-md-9">
						<div class="stat col-md-4">
							<div class="value"><%= custom_games_stats['kdRatio'] %></div>
							<div class="key">Kill/Death Ratio</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['averagePersonalScore']) %></div>
							<div class="key">Average Personal Score</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalKills']) %></div>
							<div class="key">Total Kills</div>
						</div>

						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalDeaths']) %></div>
							<div class="key">Total Deaths</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalGamesStarted']) %></div>
							<div class="key">Total Games Started</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalGamesWon']) %></div>
							<div class="key">Total Games Won</div>
						</div>

						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalGamesCompleted']) %></div>
							<div class="key">Total Games Completed</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= numberWithDelim(custom_games_stats['totalGameBaseVariantMedals']) %></div>
							<div class="key">Mode Base Medals</div>
						</div>
						<div class="stat col-md-4">
							<div class="value"><%= custom_games_stats['totalDuration'] %></div>
							<div class="key">Playtime</div>
						</div>
					</div>
					<div class="favourite-variant col-md-3">
						<div class="title">Favourite Variant</div>
						<div class="variant-icon" style="background-image: url('<%= resolve_asset_url(custom_games_stats['favoriteVariant']['imageUrl'], 'large') %>');"></div>
						<hr />

						<div class="col-md-12 row no-mp">
							<div class="col-md-12"><%= custom_games_stats['favoriteVariant']['name'] %></div>
							<div class="stat col-md-6">
								<div class="value"><%= numberWithDelim(custom_games_stats['totalKills']) %></div>
								<div class="key">Total Kills</div>
							</div>
							<div class="stat col-md-6">
								<div class="value"><%= numberWithDelim(custom_games_stats['totalDeaths']) %></div>
								<div class="key">Total Deaths</div>
							</div>
							<div class="stat col-md-6">
								<div class="value"><%= numberWithDelim(custom_games_stats['totalGamesStarted']) %></div>
								<div class="key">Games Staretd</div>
							</div>
							<div class="stat col-md-6">
								<div class="value"><%= custom_games_stats['totalDuration'] %></div>
								<div class="key">Playtime</div>
							</div>
						</div>
					</div>
				</div>
			</section>
		</div>

		<div class="col-md-2">
			<nav class="sidebar hidden-sm hidden-xs" data-spy="affix" data-offset-top="567">
				{{> halo4/sidebar}}
			</nav>
		</div>
	</div>
</div>

{{#contentFor "scripts"}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.min.js"></script>
<script>
	// Setup Recent Matches data
	const recentMatches = <%== generate_recent_match_json() %>;
	<% match_images = Array.new(@header_matches.length) %>
	<% @header_matches['games'].each_with_index do |match, index| %>
		<% match_images[index] = resolve_asset_url(match['mapImageUrl'], 'large') %>
	<% end %>
	const recentMatchImages = <%== match_images.to_json %>;

	// Setup played game spread chart
	new Chart(document.getElementById('played-games-spread'), {
		type: 'doughnut',
		data: {
			labels: <%== played_games_spread_legend_json() %>,
			datasets: [
				{
					data: <%== played_games_spread_json() %>,
					backgroundColor: [
						'rgba(255, 99, 132, 0.2)',
						'rgba(54, 162, 235, 0.2)',
						'rgba(255, 206, 86, 0.2)',
						'rgba(75, 192, 192, 0.2)',
					],
					borderColor: [
						'rgba(255,99,132,1)',
						'rgba(54, 162, 235, 1)',
						'rgba(255, 206, 86, 1)',
						'rgba(75, 192, 192, 1)',
					],
					borderWidth: 1,
				},
			],
		},
		options: {
			legend: {
				display: true,
				position: 'bottom',
			},
		},
	});
</script>
{{/contentFor}}
